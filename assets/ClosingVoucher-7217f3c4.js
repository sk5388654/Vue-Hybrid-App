import{d as Q,p as W,x as X,J as Y,k as Z,H as K,I as tt,s as R,c as x,r as et,O as st,h as nt,y as ot,o as d,a as i,b as t,w as v,v as y,i as F,t as a,F as D,e as E,n as N,D as at,f as S}from"./index-bf582a4f.js";const lt={class:"space-y-6"},dt={key:0,class:"view-card"},it={class:"grid grid-cols-1 gap-4 sm:grid-cols-2"},rt={class:"mt-4 flex justify-end"},ut=["disabled"],xt={key:1},mt={key:0,class:"view-card"},pt={class:"grid grid-cols-1 gap-4 sm:grid-cols-3"},ct={class:"mt-1 text-sm font-medium text-slate-100"},ft={class:"mt-1 text-sm font-medium text-slate-100"},gt={class:"mt-1 text-sm font-medium text-slate-100"},vt={key:1,class:"view-card text-sm text-slate-200"},bt={key:2,class:"view-card"},ht={class:"grid grid-cols-1 gap-4 sm:grid-cols-2"},Ct=["value"],yt=["value"],St={class:"mt-4 grid grid-cols-1 gap-4 sm:grid-cols-4"},kt={class:"rounded-lg border border-transparent dark-panel p-3"},wt={class:"mt-1 text-xl font-semibold text-slate-100"},_t={class:"rounded-lg border border-transparent bg-red-50 p-3"},At={class:"mt-1 text-xl font-semibold text-red-700"},Vt={class:"mt-1 text-xs text-red-600"},Rt={class:"rounded-lg border border-transparent dark-panel p-3"},Ft={class:"mt-1 text-xl font-semibold text-red-600"},Dt={class:"rounded-lg border border-transparent dark-panel p-3"},Et={class:"mt-1 text-xl font-semibold text-slate-100"},Nt={class:"mt-4 rounded-lg border border-transparent p-4"},Bt={class:"space-y-1 text-sm"},Mt={class:"text-slate-200"},It={class:"font-medium text-slate-100"},Ot={class:"mt-4 rounded-lg border border-transparent p-4"},Tt={key:0,class:"text-sm text-slate-400"},jt={key:1,class:"w-full text-sm"},Ut={class:"divide-y divide-gray-100"},$t={class:"px-3 py-2 text-slate-200"},Pt={class:"px-3 py-2 text-right text-slate-300"},Lt={class:"px-3 py-2 text-right font-medium text-slate-100"},zt={class:"mt-4"},Ht={class:"mt-4 flex items-center justify-between border-t pt-4"},Jt={class:"flex items-center gap-2 text-sm text-slate-200"},qt={class:"view-card"},Gt={class:"w-full text-sm"},Qt={class:"dark-panel"},Wt={key:0,class:"px-4 py-2 text-center text-xs font-medium text-slate-200"},Xt={class:"divide-y divide-gray-200"},Yt={key:0},Zt={class:"px-4 py-2 text-slate-200"},Kt={class:"px-4 py-2 text-slate-200"},te={class:"px-4 py-2 text-slate-200"},ee={class:"px-4 py-2 text-center"},se={key:0,class:"px-4 py-2 text-center"},ne={class:"flex items-center justify-center gap-2"},oe=["onClick"],ae=["onClick"],ie=Q({__name:"ClosingVoucher",setup(le){const u=W(),k=X(),b=Y(),B=Z(),M=K(),I=tt(),p=R({openingCash:0}),o=R({shiftStart:"",shiftEndDisplay:"--",openingCash:0,actualClosingCash:0,remarks:"",managerApproved:!1}),l=R({totalSales:0,paymentBreakdown:[],discounts:0,refunds:0,refundCount:0,refundBreakdown:{},expenses:0,expectedClosingCash:0}),O=x(()=>u.vouchersForCurrentStore),r=x(()=>u.activeShift),h=x(()=>{var s;return!!((s=r.value)!=null&&s.endedAt)}),w=x(()=>b.isManager),U=x(()=>b.isAdmin),_=x(()=>w.value||U.value),A=x(()=>o.actualClosingCash-l.expectedClosingCash),$=x(()=>A.value===0?"text-green-600":Math.abs(A.value)<100?"text-yellow-500":"text-red-600"),T=x(()=>p.openingCash>=0),P=x(()=>!!r.value&&!!r.value.endedAt&&w.value),c=et(!1),j=x(()=>{const s=l.refundBreakdown||{};return Object.keys(s).map(e=>{const m=s[e]||{amount:0,count:0},n=e.replace(/_/g," ").replace(/\b\w/g,g=>g.toUpperCase());return{type:e,amount:m.amount,count:m.count,label:n}})}),f=s=>{if(!s)return"--";const e=new Date(s);return Number.isNaN(e.getTime())?"--":e.toLocaleString()};function L(){var s;if(!T.value){alert("Opening cash must be zero or greater.");return}u.startShift(Number(p.openingCash)),p.openingCash=((s=u.lastVoucher)==null?void 0:s.actualClosingCash)??0,c.value=!1,V()}function z(){u.endShift(),c.value=!1,V()}function V(){r.value&&(o.shiftStart=f(r.value.start),o.shiftEndDisplay=h.value?f(r.value.endedAt):"--",o.openingCash=r.value.openingCash,c.value=!1,C())}function C(){if(!r.value)return;const s=r.value.endedAt??new Date().toISOString();o.shiftEndDisplay=h.value?f(r.value.endedAt):`${f(s)} (preview)`;const e=u.computeSnapshot({openingCash:Number(o.openingCash),shiftStart:r.value.start,shiftEnd:s});Object.assign(l,e),c.value||(o.actualClosingCash=e.expectedClosingCash)}st(()=>{const s=r.value;s&&(s.endedAt,B.sales,M.expensesForCurrentStore,I.refundsForCurrentStore,C())}),nt(()=>u.lastVoucher,s=>{r.value||(p.openingCash=(s==null?void 0:s.actualClosingCash)??0)});function H(){var m,n;if(!P.value||!r.value){alert("Only managers can submit the closing voucher after the shift has ended.");return}const s=k.stores.find(g=>g.id===k.currentStoreId),e=u.closeShift({storeId:k.currentStoreId,storeName:(s==null?void 0:s.name)||"Unknown Store",cashierName:((m=b.user)==null?void 0:m.displayName)||((n=b.user)==null?void 0:n.username)||"Cashier",openingCash:Number(o.openingCash),actualClosingCash:Number(o.actualClosingCash),remarks:o.remarks||void 0,managerApproved:o.managerApproved});window.open(`/print/closing/${e.id}`,"_blank"),J()}function J(){var s;o.shiftStart="",o.shiftEndDisplay="--",o.openingCash=0,o.actualClosingCash=0,o.remarks="",o.managerApproved=!1,l.totalSales=0,l.paymentBreakdown=[],l.discounts=0,l.refunds=0,l.refundCount=0,l.refundBreakdown={},l.expenses=0,l.expectedClosingCash=0,c.value=!1,p.openingCash=((s=u.lastVoucher)==null?void 0:s.actualClosingCash)??0}function q(s){window.open(`/print/closing/${s}`,"_blank")}function G(s){if(!globalThis.confirm("Are you sure you want to delete this closing voucher? This action cannot be undone."))return;const m=u.deleteVoucher(s);alert(m?"Closing voucher deleted.":"Unable to delete voucher. It may have already been removed or no store is selected.")}return ot(()=>{var s;B.load(),M.load(),I.load(),u.setCurrentStore(),p.openingCash=((s=u.lastVoucher)==null?void 0:s.actualClosingCash)??0,r.value&&V()}),(s,e)=>{var m;return d(),i("div",lt,[r.value?(d(),i("div",xt,[h.value?h.value&&!w.value?(d(),i("div",vt,[e[14]||(e[14]=t("h2",{class:"mb-3 text-lg font-semibold text-slate-100"},"Shift Ended",-1)),t("p",null,"Shift ended at "+a(f((m=r.value)==null?void 0:m.endedAt))+".",1),e[15]||(e[15]=t("p",{class:"mt-2"},"Please wait for a manager to review and submit the closing voucher.",-1))])):(d(),i("div",bt,[e[30]||(e[30]=t("h2",{class:"mb-3 text-lg font-semibold text-slate-100"},"Close Shift (Manager)",-1)),t("div",ht,[t("div",null,[e[16]||(e[16]=t("label",{class:"block text-sm text-slate-200"},"Shift Start",-1)),t("input",{value:o.shiftStart,type:"text",disabled:"",class:"mt-1 w-full rounded-md border border-[rgba(255,255,255,0.06)] dark-panel px-3 py-2 text-sm"},null,8,Ct)]),t("div",null,[e[17]||(e[17]=t("label",{class:"block text-sm text-slate-200"},"Shift End",-1)),t("input",{value:o.shiftEndDisplay,type:"text",disabled:"",class:"mt-1 w-full rounded-md border border-[rgba(255,255,255,0.06)] dark-panel px-3 py-2 text-sm"},null,8,yt)]),t("div",null,[e[18]||(e[18]=t("label",{class:"block text-sm text-slate-200"},"Opening Cash (Rs)",-1)),v(t("input",{"onUpdate:modelValue":e[1]||(e[1]=n=>o.openingCash=n),type:"number",min:"0",step:"0.01",class:"mt-1 w-full rounded-md border border-[rgba(255,255,255,0.06)] px-3 py-2 text-sm outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500",onInput:e[2]||(e[2]=n=>{c.value=!1,C()})},null,544),[[y,o.openingCash,void 0,{number:!0}]])]),t("div",null,[e[19]||(e[19]=t("label",{class:"block text-sm text-slate-200"},"Actual Cash Counted (Rs)",-1)),v(t("input",{"onUpdate:modelValue":e[3]||(e[3]=n=>o.actualClosingCash=n),type:"number",min:"0",step:"0.01",class:"mt-1 w-full rounded-md border border-[rgba(255,255,255,0.06)] px-3 py-2 text-sm outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500",onInput:e[4]||(e[4]=n=>c.value=!0)},null,544),[[y,o.actualClosingCash,void 0,{number:!0}]])])]),t("div",St,[t("div",kt,[e[20]||(e[20]=t("div",{class:"text-xs text-slate-300"},"Total Sales",-1)),t("div",wt,"Rs "+a(l.totalSales.toFixed(2)),1)]),t("div",_t,[e[21]||(e[21]=t("div",{class:"text-xs text-red-600"},"Total Refunds",-1)),t("div",At,"Rs "+a(l.refunds.toFixed(2)),1),t("div",Vt,"Count: "+a(l.refundCount),1)]),t("div",Rt,[e[22]||(e[22]=t("div",{class:"text-xs text-slate-300"},"Expenses",-1)),t("div",Ft,"Rs "+a(l.expenses.toFixed(2)),1)]),t("div",Dt,[e[23]||(e[23]=t("div",{class:"text-xs text-slate-300"},"Expected Closing Cash",-1)),t("div",Et," Rs "+a(l.expectedClosingCash.toFixed(2)),1)])]),t("div",Nt,[e[24]||(e[24]=t("h3",{class:"mb-2 text-sm font-semibold text-slate-200"},"Payment Breakdown",-1)),t("ul",Bt,[(d(!0),i(D,null,E(l.paymentBreakdown,n=>(d(),i("li",{key:n.method,class:"flex items-center justify-between"},[t("span",Mt,a(n.method),1),t("span",It,"Rs "+a(n.amount.toFixed(2)),1)]))),128))])]),t("div",Ot,[e[26]||(e[26]=t("h3",{class:"mb-2 text-sm font-semibold text-slate-200"},"Refund Summary",-1)),j.value.length?(d(),i("table",jt,[e[25]||(e[25]=t("thead",{class:"dark-panel text-slate-300"},[t("tr",null,[t("th",{class:"px-3 py-2 text-left text-xs font-medium uppercase tracking-wide"},"Type"),t("th",{class:"px-3 py-2 text-right text-xs font-medium uppercase tracking-wide"},"Count"),t("th",{class:"px-3 py-2 text-right text-xs font-medium uppercase tracking-wide"},"Amount (Rs)")])],-1)),t("tbody",Ut,[(d(!0),i(D,null,E(j.value,n=>(d(),i("tr",{key:n.type},[t("td",$t,a(n.label),1),t("td",Pt,a(n.count),1),t("td",Lt,"Rs "+a(n.amount.toFixed(2)),1)]))),128))])])):(d(),i("div",Tt," No refunds recorded during this shift. "))]),t("div",zt,[e[27]||(e[27]=t("label",{class:"block text-sm text-slate-200"},"Remarks",-1)),v(t("textarea",{"onUpdate:modelValue":e[5]||(e[5]=n=>o.remarks=n),rows:"2",class:"mt-1 w-full rounded-md border border-[rgba(255,255,255,0.06)] px-3 py-2 text-sm outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"},null,512),[[y,o.remarks]])]),t("div",Ht,[t("div",null,[e[28]||(e[28]=t("div",{class:"text-sm text-slate-300"},"Difference",-1)),t("div",{class:N(["mt-1 text-xl font-semibold",$.value])},"Rs "+a(A.value.toFixed(2)),3)]),t("label",Jt,[v(t("input",{"onUpdate:modelValue":e[6]||(e[6]=n=>o.managerApproved=n),type:"checkbox",class:"h-4 w-4 rounded border-[rgba(255,255,255,0.06)] text-indigo-600 focus:ring-indigo-500"},null,512),[[at,o.managerApproved]]),e[29]||(e[29]=F(" Manager Approved ",-1))])]),t("div",{class:"mt-4 flex justify-end gap-2"},[t("button",{class:"rounded-md border border-[rgba(255,255,255,0.06)] px-4 py-2 text-sm",onClick:C},"Recalculate"),t("button",{class:"rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white",onClick:H}," Submit Voucher ")])])):(d(),i("div",mt,[e[13]||(e[13]=t("h2",{class:"mb-3 text-lg font-semibold text-slate-100"},"Active Shift",-1)),t("div",pt,[t("div",null,[e[10]||(e[10]=t("div",{class:"text-xs text-slate-300"},"Shift Start",-1)),t("div",ct,a(o.shiftStart),1)]),t("div",null,[e[11]||(e[11]=t("div",{class:"text-xs text-slate-300"},"Opening Cash",-1)),t("div",ft,"Rs "+a(o.openingCash.toFixed(2)),1)]),t("div",null,[e[12]||(e[12]=t("div",{class:"text-xs text-slate-300"},"Current Sales",-1)),t("div",gt,"Rs "+a(l.totalSales.toFixed(2)),1)])]),t("div",{class:"mt-4 flex justify-end"},[t("button",{class:"rounded-md bg-red-600 px-4 py-2 text-sm font-medium text-white",onClick:z}," End Shift ")])]))])):(d(),i("div",dt,[e[9]||(e[9]=t("h2",{class:"mb-3 text-lg font-semibold text-slate-100"},"Start Shift",-1)),t("div",it,[t("div",null,[e[7]||(e[7]=t("label",{class:"block text-sm text-slate-200"},"Opening Cash (Rs)",-1)),v(t("input",{"onUpdate:modelValue":e[0]||(e[0]=n=>p.openingCash=n),type:"number",min:"0",step:"0.01",class:"mt-1 w-full rounded-md border border-[rgba(255,255,255,0.06)] px-3 py-2 text-sm outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500"},null,512),[[y,p.openingCash,void 0,{number:!0}]])]),e[8]||(e[8]=t("div",{class:"flex items-end"},[t("p",{class:"text-xs text-slate-400"},[F(" Shift start time will be captured automatically when you press "),t("strong",null,"Start Shift"),F(". ")])],-1))]),t("div",rt,[t("button",{disabled:!T.value,class:"rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white disabled:cursor-not-allowed disabled:bg-gray-600",onClick:L}," Start Shift ",8,ut)])])),t("div",qt,[e[37]||(e[37]=t("h3",{class:"mb-3 text-lg font-semibold text-slate-100"},"Recent Vouchers",-1)),t("table",Gt,[t("thead",Qt,[t("tr",null,[e[31]||(e[31]=t("th",{class:"px-4 py-2 text-left text-xs font-medium text-slate-200"},"Date",-1)),e[32]||(e[32]=t("th",{class:"px-4 py-2 text-left text-xs font-medium text-slate-200"},"Cashier",-1)),e[33]||(e[33]=t("th",{class:"px-4 py-2 text-left text-xs font-medium text-slate-200"},"Sales",-1)),e[34]||(e[34]=t("th",{class:"px-4 py-2 text-left text-xs font-medium text-slate-200"},"Difference",-1)),e[35]||(e[35]=t("th",{class:"px-4 py-2 text-center text-xs font-medium text-slate-200"},"Manager",-1)),_.value?(d(),i("th",Wt,"Actions")):S("",!0)])]),t("tbody",Xt,[O.value.length===0?(d(),i("tr",Yt,[...e[36]||(e[36]=[t("td",{colspan:"6",class:"px-4 py-4 text-center text-slate-400"},"No closing vouchers yet.",-1)])])):S("",!0),(d(!0),i(D,null,E(O.value.slice(-10).reverse(),n=>(d(),i("tr",{key:n.id},[t("td",Zt,a(f(n.shiftEnd)),1),t("td",Kt,a(n.cashierName),1),t("td",te,"Rs "+a(n.totalSales.toFixed(2)),1),t("td",{class:N(["px-4 py-2 font-semibold",n.difference===0?"text-green-600":"text-red-600"])}," Rs "+a(n.difference.toFixed(2)),3),t("td",ee,[t("span",{class:N(["inline-flex rounded-full px-2 py-1 text-xs font-medium",n.managerApproved?"bg-green-100 text-green-800":"dark-panel text-slate-300"])},a(n.managerApproved?"Approved":"Pending"),3)]),_.value?(d(),i("td",se,[t("div",ne,[t("button",{class:"rounded-md border border-indigo-300 bg-indigo-50 px-3 py-1 text-xs font-medium text-indigo-700 hover:bg-indigo-100",onClick:g=>q(n.id)}," View / Print ",8,oe),_.value?(d(),i("button",{key:0,class:"rounded-md border border-red-300 bg-red-50 px-3 py-1 text-xs font-medium text-red-700 hover:bg-red-100",onClick:g=>G(n.id)}," Delete ",8,ae)):S("",!0)])])):S("",!0)]))),128))])])])])}}});export{ie as default};
