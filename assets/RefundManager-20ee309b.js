import{d as Re,k as he,j as be,K as ye,r as A,c as q,h as fe,o as i,a as u,b as e,t as l,F as W,e as ee,f as I,w as de,v as ve,D as me,i as ae,n as ce,C as $,L as Ce,q as $e,s as Ie,S as _e,R as Ne,y as Qe,U as Pe,V as Me,G as we}from"./index-95881755.js";import{_ as Ee}from"./RefundReceiptModal.vue_vue_type_script_setup_true_lang-637f8107.js";import"./print-952bbe55.js";function pe(R,N){const b=R.reduce((s,d)=>s+d.lineTotal,0),C=N.reduce((s,d)=>s+d.lineTotal,0),p=b-C;return{returnValue:b,exchangeValue:C,difference:p,customerPays:p<0?Math.abs(p):0,customerReceives:p>0?p:0,isEvenExchange:p===0}}function ge(R,N,b,C){const p=[],s=[];if(!R)return p.push("Original invoice must be selected before processing exchange."),{valid:!1,errors:p,warnings:s};N.length===0&&p.push("Please select items to return."),b.length===0&&p.push("Please select items for exchange.");const d=new Map;R.items.forEach(y=>{d.set(y.id,y.quantity)});for(const y of N){const c=d.get(y.id)||0;y.quantity>c&&p.push(`Cannot return ${y.quantity} of "${y.name}". Only ${c} were purchased.`)}for(const y of b){const c=C.products.find(M=>M.id===y.id);if(!c){p.push(`Product "${y.name}" not found in inventory.`);continue}const x=c.stock||0;y.quantity>x&&p.push(`Insufficient stock for "${y.name}". Available: ${x}, Required: ${y.quantity}`),x-y.quantity<3&&s.push(`Low stock warning: "${y.name}" will have ${x-y.quantity} units remaining.`)}return{valid:p.length===0,errors:p,warnings:s}}function Se(R,N,b){R.forEach(C=>{const p=b.products.find(s=>s.id===C.id);p&&b.update(p.id,{stock:(p.stock||0)+C.quantity})}),N.length>0&&b.decrementStock(N.map(C=>({id:C.id,quantity:C.quantity})))}function xe(R,N,b,C,p){var y,c;const s=R.reduce((x,M)=>x+M.lineTotal,0),d=R.map(x=>({id:x.id,name:x.name,quantity:x.quantity,unitPrice:x.unitPrice,discountMode:"flat",discountValue:0,lineDiscount:0,lineTotal:x.lineTotal}));return C.recordSale({datetime:new Date().toISOString(),items:d,subtotal:s,productDiscountTotal:0,invoiceDiscountMode:"flat",invoiceDiscountValue:0,invoiceDiscountAmount:0,totalDiscount:0,total:s,paymentType:b,cashier:((y=p.user)==null?void 0:y.displayName)||((c=p.user)==null?void 0:c.username)||"Cashier",customerId:N.customerId,customerName:N.customerName})}function De(R,N,b,C){var d,y;const p=R.reduce((c,x)=>c+x.lineTotal,0),s=R.map(c=>({id:c.id,name:c.name,quantity:c.quantity,unitPrice:c.unitPrice,discountMode:"flat",discountValue:0,lineDiscount:0,lineTotal:c.lineTotal}));return b.recordSale({datetime:new Date().toISOString(),items:s,subtotal:p,productDiscountTotal:0,invoiceDiscountMode:"flat",invoiceDiscountValue:0,invoiceDiscountAmount:0,totalDiscount:0,total:-p,paymentType:"cash",cashier:((d=C.user)==null?void 0:d.displayName)||((y=C.user)==null?void 0:y.username)||"Cashier",customerId:N.customerId,customerName:N.customerName})}async function Fe(R,N,b,C,p,s,d,y,c,x){var M,w,F,G,j,H;try{const V=pe(N,b),ne=ge(R,N,b,y);if(!ne.valid)return{success:!1,difference:V.difference,message:`Validation failed: ${ne.errors.join(" ")}`};Se(N,b,y);let K,S,P,J,te,z;if(V.difference<0){const D=xe(b,R,s,d,x);K=D.id,S=D.invoiceNumber,te=V.customerPays;const U=c.recordRefund({saleId:R.id,invoiceNumber:R.invoiceNumber,refundType:"exchange",refundReason:C||"Exchange - Customer pays difference",refundedItems:N,exchangedItems:b,totalRefund:0,refundMethod:"Exchange - New Sale",paymentMethod:s,exchangeDifference:V.difference,exchangeSaleId:D.id,cashier:((M=x.user)==null?void 0:M.displayName)||((w=x.user)==null?void 0:w.username)||"Cashier"});return{success:!0,refundRecordId:U==null?void 0:U.refundId,newSaleInvoiceId:K,newSaleInvoiceNumber:S,difference:V.difference,paymentCollected:te,message:`Exchange complete. New invoice #${S} created. Customer pays ₹${te.toFixed(2)}.`}}else if(V.difference>0){const D=xe(b,R,s,d,x);K=D.id,S=D.invoiceNumber;const U=De(N,R,d,x);P=U.id,J=U.invoiceNumber,z=V.customerReceives;const X=c.recordRefund({saleId:R.id,invoiceNumber:R.invoiceNumber,refundType:"exchange",refundReason:C||`Exchange - Refund via ${p}`,refundedItems:N,exchangedItems:b,totalRefund:z,refundMethod:p==="cash"?"Cash Refund":p==="store_credit"?"Store Credit":"Wallet Credit",paymentMethod:R.paymentType,exchangeDifference:V.difference,exchangeSaleId:D.id,cashier:((F=x.user)==null?void 0:F.displayName)||((G=x.user)==null?void 0:G.username)||"Cashier"});return{success:!0,refundRecordId:X==null?void 0:X.refundId,newSaleInvoiceId:K,newSaleInvoiceNumber:S,returnInvoiceId:P,returnInvoiceNumber:J,difference:V.difference,refundIssued:z,refundMethod:p,message:`Exchange complete. New invoice #${S} created. Return note #${J} issued. Refund ₹${z.toFixed(2)} via ${p}.`}}else{const D=xe(b,R,s,d,x);K=D.id,S=D.invoiceNumber;const U=c.recordRefund({saleId:R.id,invoiceNumber:R.invoiceNumber,refundType:"exchange",refundReason:C||"Even exchange - No balance due",refundedItems:N,exchangedItems:b,totalRefund:0,refundMethod:"Even Exchange",paymentMethod:R.paymentType,exchangeDifference:0,exchangeSaleId:D.id,cashier:((j=x.user)==null?void 0:j.displayName)||((H=x.user)==null?void 0:H.username)||"Cashier"});return{success:!0,refundRecordId:U==null?void 0:U.refundId,newSaleInvoiceId:K,newSaleInvoiceNumber:S,difference:0,message:`Even exchange complete. New invoice #${S} created. No balance due.`}}}catch(V){return{success:!1,difference:0,message:V instanceof Error?V.message:"Unknown error occurred during exchange processing."}}}const qe={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4"},Ve={class:"w-full max-w-4xl rounded-lg dark-panel"},Ue={class:"flex items-center justify-between border-b border-transparent px-6 py-4"},Ae={class:"mt-1 text-sm text-slate-400"},Le={class:"border-b border-transparent px-6 py-3"},je={class:"flex items-center justify-between"},ze={class:"max-h-[60vh] overflow-y-auto px-6 py-4"},Oe={key:0,class:"space-y-4"},Be={key:0,class:"rounded-lg border border-transparent"},We={class:"dark-panel px-4 py-2 text-sm font-semibold text-slate-200"},Ge={class:"min-w-full text-sm"},He={class:"divide-y divide-gray-200"},Ke={class:"px-4 py-2 font-medium text-slate-100"},Je={class:"px-4 py-2 text-right"},Xe={class:"px-4 py-2 text-right text-slate-400"},Ye={class:"px-4 py-2 text-right"},Ze={class:"px-4 py-2 text-right"},et={class:"flex flex-col items-end"},tt={class:"text-xs line-through text-slate-400"},st={class:"text-sm font-semibold text-slate-100"},nt={class:"px-4 py-2 text-right"},at=["value","max","onInput"],lt={key:1,class:"space-y-4"},rt={class:"space-y-3"},ot={class:"rounded-lg border border-transparent"},it={class:"min-w-full text-xs"},dt={class:"divide-y divide-gray-200"},ut={class:"px-3 py-2 font-medium text-slate-100"},ct={class:"px-3 py-2 text-right"},xt={class:"px-3 py-2 text-right"},ft={class:"px-3 py-2 text-right"},vt=["value","max","onInput"],mt={class:"px-3 py-2 text-right"},pt=["value","onChange"],gt={class:"px-3 py-2 text-right"},ht=["value","onInput"],bt={key:0,class:"px-3 py-2 text-right text-slate-100"},yt={class:"text-xs font-semibold"},kt={key:1,class:"px-3 py-2 text-right text-slate-100"},_t={class:"text-xs font-semibold"},wt={class:"rounded-lg border border-transparent dark-panel p-3"},Rt={class:"flex items-center gap-2"},$t=["value"],Tt=["value"],Ct={class:"text-xs text-slate-400"},It={key:2,class:"space-y-4"},Nt={key:0,class:"space-y-4"},Qt={class:"rounded-lg border border-transparent p-3"},Pt={class:"min-w-full text-xs"},Mt={class:"divide-y divide-gray-100"},Et={class:"px-2 py-1"},St={class:"px-2 py-1 text-right"},Dt={class:"px-2 py-1 text-right"},Ft={class:"px-2 py-1 text-right font-semibold"},qt={class:"mt-2 pt-2 border-t border-transparent text-right"},Vt={class:"text-sm font-semibold text-slate-100"},Ut={class:"rounded-lg border border-transparent p-3"},At={class:"min-w-full text-xs"},Lt={class:"divide-y divide-gray-100"},jt={class:"px-2 py-1"},zt={class:"px-2 py-1 text-right"},Ot={class:"px-2 py-1 text-right"},Bt={class:"px-2 py-1 text-right font-semibold"},Wt={class:"px-2 py-1 text-right font-semibold"},Gt={class:"mt-2 pt-2 border-t border-transparent text-right"},Ht={class:"text-sm font-semibold text-slate-100"},Kt={class:"grid grid-cols-2 gap-3"},Jt={class:"rounded-lg border border-transparent dark-panel p-3"},Xt={class:"mt-1 text-lg font-semibold text-slate-100"},Yt={class:"rounded-lg border border-transparent dark-panel p-3"},Zt={class:"mt-1 text-lg font-semibold text-slate-100"},es={key:0,class:"rounded-lg border border-orange-200 bg-orange-50 p-4"},ts={class:"mt-1 text-2xl font-bold text-orange-900"},ss={key:1,class:"rounded-lg border border-green-200 bg-green-50 p-4"},ns={class:"mt-1 text-2xl font-bold text-green-900"},as={key:2,class:"rounded-lg border border-blue-200 bg-blue-50 p-4"},ls={key:3,class:"rounded-lg border border-yellow-200 bg-yellow-50 p-3"},rs={class:"mt-1 list-disc list-inside text-xs text-yellow-700"},os={key:4,class:"rounded-lg border border-red-200 bg-red-50 p-3"},is={class:"mt-1 list-disc list-inside text-xs text-red-700"},ds={key:3,class:"space-y-4"},us={class:"space-y-4"},cs={key:0},xs={class:"mt-1 text-xs text-slate-400"},fs={key:1},vs={class:"mt-1 text-xs text-slate-400"},ms={key:4,class:"space-y-4"},ps={class:"rounded-lg border border-transparent dark-panel p-4"},gs={class:"space-y-2 text-sm"},hs={key:0},bs={class:"flex items-center justify-between border-t border-transparent px-6 py-4"},ys={key:1},ks={class:"flex gap-2"},_s=["disabled"],ue=5,ws=Re({__name:"ExchangeModal",props:{originalSale:{},show:{type:Boolean}},emits:["close","confirm"],setup(R,{emit:N}){const b=R,C=N;he();const p=be(),s=ye(),d=A(1),y=A(new Map),c=A(new Map),x=A(new Map),M=A({mode:"flat",value:0}),w=A(null),F=A(null),G=A(""),j=A("cash"),H=A("cash"),V=A(!1),ne=q(()=>{if(!b.originalSale)return[];const _=s.refundsForSale(b.originalSale.id),t=new Map;return _.forEach(m=>{m.refundedItems.forEach(T=>{t.set(T.id,(t.get(T.id)||0)+T.quantity)})}),b.originalSale.items.map(m=>{const T=t.get(m.id)||0,n=Math.max(0,m.quantity-T);return{productId:m.id,name:m.name,purchasedQty:m.quantity,refundedQty:T,remainingQty:n,originalUnitPrice:m.unitPrice,unitPrice:m.lineTotal?m.lineTotal/m.quantity:m.unitPrice,lineTotal:m.lineTotal??m.unitPrice*m.quantity}})}),K=q(()=>p.products.filter(_=>(_.stock||0)>0)),S=q(()=>{const _=[];return y.value.forEach((t,m)=>{if(t<=0)return;const T=ne.value.find(n=>n.productId===m);T&&_.push({id:m,name:T.name,quantity:t,unitPrice:T.unitPrice,lineTotal:T.unitPrice*t})}),_}),P=q(()=>{const _=[],t=Array.from(c.value.entries()).reduce((m,[T,n])=>{if(n<=0)return m;const E=p.products.find(o=>o.id===T);return E?m+E.price*n:m},0);return c.value.forEach((m,T)=>{if(m<=0)return;const n=p.products.find(L=>L.id===T);if(!n)return;const E=x.value.get(T)||{mode:"flat",value:0},o=n.price*m;let v=0;E.mode==="percent"?v=o*Math.min(E.value,100)/100:v=Math.min(E.value,o);const f=Math.max(0,o-v);let h=0;if(t>0&&(M.value.mode||M.value.value>0)){const L=o/t;M.value.mode==="percent"?h=f*Math.min(M.value.value,100)/100:h=M.value.value*L}const k=Math.max(0,f-h),Q=m>0?k/m:0;_.push({id:T,name:n.name,quantity:m,unitPrice:Q,lineTotal:k})}),_});fe([y,c,x,M],()=>{S.value.length>0&&P.value.length>0?(w.value=pe(S.value,P.value),F.value=ge(b.originalSale,S.value,P.value,p)):(w.value=null,F.value=null)},{deep:!0});function J(_,t){const m=ne.value.find(n=>n.productId===_);if(!m)return;const T=Math.min(Math.max(t,0),m.remainingQty);T<=0?y.value.delete(_):y.value.set(_,T)}function te(_,t){const m=p.products.find(n=>n.id===_);if(!m)return;const T=Math.min(Math.max(t,0),m.stock||0);T<=0?(c.value.delete(_),x.value.delete(_)):c.value.set(_,T)}function z(_,t,m){const T=c.value.get(_);if(!T||T<=0)return;const n=p.products.find(v=>v.id===_);if(!n)return;const E=n.price*T;let o=Math.max(m,0);t==="percent"?o=Math.min(o,100):o=Math.min(o,E),o<=0?x.value.delete(_):x.value.set(_,{mode:t,value:o})}function D(_,t){let m=Math.max(t,0);_==="percent"&&(m=Math.min(m,100)),M.value={mode:_,value:m}}function U(){var _;if(d.value===1){if(S.value.length===0){alert("Please select at least one item to return.");return}}else if(d.value===2){if(P.value.length===0){alert("Please select at least one item for exchange.");return}if(w.value=pe(S.value,P.value),F.value=ge(b.originalSale,S.value,P.value,p),!F.value.valid){alert(`Validation errors:
${F.value.errors.join(`
`)}`);return}}else if(d.value===3&&!((_=F.value)!=null&&_.valid)){alert("Please fix validation errors before proceeding.");return}d.value<ue&&d.value++}function X(){d.value>1&&d.value--}function re(){var _;if(!((_=F.value)!=null&&_.valid)){alert("Please fix validation errors before confirming.");return}V.value=!0,C("confirm",{returnedItems:S.value,exchangedItems:P.value,refundReason:G.value.trim(),refundMethod:j.value,paymentType:H.value})}function le(){d.value=1,y.value.clear(),c.value.clear(),x.value.clear(),M.value={mode:"flat",value:0},w.value=null,F.value=null,G.value="",j.value="cash",H.value="cash",V.value=!1,C("close")}return fe(()=>b.show,_=>{_||le()}),(_,t)=>{var m,T;return R.show?(i(),u("div",qe,[e("div",Ve,[e("div",Ue,[e("div",null,[t[5]||(t[5]=e("h2",{class:"text-xl font-semibold text-slate-100"},"Exchange Process",-1)),e("p",Ae," Step "+l(d.value)+" of "+l(ue),1)]),e("button",{type:"button",class:"rounded-md p-2 text-slate-400 hover:dark-panel hover:text-slate-300",onClick:le},[...t[6]||(t[6]=[e("svg",{class:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),e("div",Le,[e("div",je,[(i(),u(W,null,ee(ue,n=>e("div",{key:n,class:"flex flex-1 items-center"},[e("div",{class:ce(["flex h-8 w-8 items-center justify-center rounded-full text-sm font-medium",n<d.value?"bg-green-500 text-white":n===d.value?"bg-orange-500 text-white":"bg-gray-200 text-slate-300"])},l(n),3),n<ue?(i(),u("div",{key:0,class:ce(["h-1 flex-1",n<d.value?"bg-green-500":"bg-gray-200"])},null,2)):I("",!0)])),64))])]),e("div",ze,[d.value===1?(i(),u("div",Oe,[t[8]||(t[8]=e("h3",{class:"text-lg font-semibold text-slate-100"},"Step 1: Select Items to Return",-1)),t[9]||(t[9]=e("p",{class:"text-sm text-slate-300"},"Select the items from the original invoice that the customer wants to return.",-1)),R.originalSale?(i(),u("div",Be,[e("div",We," Original Invoice: #"+l(R.originalSale.invoiceNumber),1),e("table",Ge,[t[7]||(t[7]=e("thead",{class:"dark-panel"},[e("tr",null,[e("th",{class:"px-4 py-2 text-left font-medium text-slate-200"},"Item"),e("th",{class:"px-4 py-2 text-right font-medium text-slate-200"},"Purchased"),e("th",{class:"px-4 py-2 text-right font-medium text-slate-200"},"Refunded"),e("th",{class:"px-4 py-2 text-right font-medium text-slate-200"},"Available"),e("th",{class:"px-4 py-2 text-right font-medium text-slate-200"},"Unit Price"),e("th",{class:"px-4 py-2 text-right font-medium text-slate-200"},"Return Qty")])],-1)),e("tbody",He,[(i(!0),u(W,null,ee(ne.value,n=>(i(),u("tr",{key:n.productId},[e("td",Ke,l(n.name),1),e("td",Je,l(n.purchasedQty),1),e("td",Xe,l(n.refundedQty),1),e("td",Ye,l(n.remainingQty),1),e("td",Ze,[e("div",et,[e("span",tt,"₹"+l(n.originalUnitPrice.toFixed(2)),1),e("span",st,"₹"+l(n.unitPrice.toFixed(2)),1)])]),e("td",nt,[e("input",{value:y.value.get(n.productId)||0,max:n.remainingQty,min:"0",type:"number",class:"w-20 rounded-md border border-[rgba(255,255,255,0.06)] px-2 py-1 text-right text-sm",onInput:E=>J(n.productId,Number(E.target.value))},null,40,at)])]))),128))])])])):I("",!0)])):I("",!0),d.value===2?(i(),u("div",lt,[t[15]||(t[15]=e("h3",{class:"text-lg font-semibold text-slate-100"},"Step 2: Select Items for Exchange",-1)),t[16]||(t[16]=e("p",{class:"text-sm text-slate-300"},"Select the new items the customer wants in exchange. Apply discounts if needed.",-1)),e("div",rt,[e("div",ot,[t[12]||(t[12]=e("div",{class:"dark-panel px-4 py-2 text-sm font-semibold text-slate-200"}," Available Products ",-1)),e("table",it,[t[11]||(t[11]=e("thead",{class:"dark-panel"},[e("tr",null,[e("th",{class:"px-3 py-2 text-left font-medium text-slate-200"},"Item"),e("th",{class:"px-3 py-2 text-right font-medium text-slate-200"},"Stock"),e("th",{class:"px-3 py-2 text-right font-medium text-slate-200"},"Unit Price"),e("th",{class:"px-3 py-2 text-right font-medium text-slate-200"},"Qty"),e("th",{class:"px-3 py-2 text-right font-medium text-slate-200"},"Discount Type"),e("th",{class:"px-3 py-2 text-right font-medium text-slate-200"},"Discount Value"),e("th",{class:"px-3 py-2 text-right font-medium text-slate-200"},"Net Rate"),e("th",{class:"px-3 py-2 text-right font-medium text-slate-200"},"Net Total")])],-1)),e("tbody",dt,[(i(!0),u(W,null,ee(K.value,n=>{var E,o,v,f;return i(),u("tr",{key:n.id},[e("td",ut,l(n.name),1),e("td",ct,l(n.stock),1),e("td",xt,"₹"+l(n.price.toFixed(2)),1),e("td",ft,[e("input",{value:c.value.get(n.id)||0,max:n.stock,min:"0",type:"number",class:"w-16 rounded-md border border-[rgba(255,255,255,0.06)] px-2 py-1 text-right text-xs",onInput:h=>te(n.id,Number(h.target.value))},null,40,vt)]),e("td",mt,[c.value.get(n.id)?(i(),u("select",{key:0,value:((E=x.value.get(n.id))==null?void 0:E.mode)||"flat",class:"w-20 rounded-md border border-[rgba(255,255,255,0.06)] px-2 py-1 text-xs",onChange:h=>{var k;return z(n.id,h.target.value,((k=x.value.get(n.id))==null?void 0:k.value)||0)}},[...t[10]||(t[10]=[e("option",{value:"flat"},"₹",-1),e("option",{value:"percent"},"%",-1)])],40,pt)):I("",!0)]),e("td",gt,[c.value.get(n.id)?(i(),u("input",{key:0,value:((o=x.value.get(n.id))==null?void 0:o.value)||0,min:"0",type:"number",class:"w-16 rounded-md border border-[rgba(255,255,255,0.06)] px-2 py-1 text-right text-xs",onInput:h=>{var k;return z(n.id,((k=x.value.get(n.id))==null?void 0:k.mode)||"flat",Number(h.target.value))}},null,40,ht)):I("",!0)]),c.value.get(n.id)?(i(),u("td",bt,[e("span",yt," ₹"+l((((v=P.value.find(h=>h.id===n.id))==null?void 0:v.lineTotal)??0/(c.value.get(n.id)||1)).toFixed(2)),1)])):I("",!0),c.value.get(n.id)?(i(),u("td",kt,[e("span",_t," ₹"+l((((f=P.value.find(h=>h.id===n.id))==null?void 0:f.lineTotal)??0).toFixed(2)),1)])):I("",!0)])}),128))])])]),e("div",wt,[t[14]||(t[14]=e("div",{class:"text-sm font-semibold text-slate-200 mb-2"},"Global Discount (for new items)",-1)),e("div",Rt,[e("select",{value:M.value.mode,class:"w-20 rounded-md border border-[rgba(255,255,255,0.06)] px-2 py-1 text-sm",onChange:t[0]||(t[0]=n=>D(n.target.value,M.value.value))},[...t[13]||(t[13]=[e("option",{value:"flat"},"Flat (₹)",-1),e("option",{value:"percent"},"Percent (%)",-1)])],40,$t),e("input",{value:M.value.value,min:"0",type:"number",class:"w-24 rounded-md border border-[rgba(255,255,255,0.06)] px-2 py-1 text-sm",onInput:t[1]||(t[1]=n=>D(M.value.mode,Number(n.target.value)))},null,40,Tt),e("span",Ct,l(M.value.mode==="percent"?"%":"₹"),1)])])])])):I("",!0),d.value===3?(i(),u("div",It,[t[30]||(t[30]=e("h3",{class:"text-lg font-semibold text-slate-100"},"Step 3: Review Exchange Calculation",-1)),w.value?(i(),u("div",Nt,[e("div",Qt,[t[18]||(t[18]=e("div",{class:"text-sm font-semibold text-slate-200 mb-2"},"Returned Items Value",-1)),e("table",Pt,[t[17]||(t[17]=e("thead",{class:"dark-panel"},[e("tr",null,[e("th",{class:"px-2 py-1 text-left"},"Item"),e("th",{class:"px-2 py-1 text-right"},"Qty"),e("th",{class:"px-2 py-1 text-right"},"Unit Price"),e("th",{class:"px-2 py-1 text-right"},"Total")])],-1)),e("tbody",Mt,[(i(!0),u(W,null,ee(S.value,n=>(i(),u("tr",{key:n.id},[e("td",Et,l(n.name),1),e("td",St,l(n.quantity),1),e("td",Dt,"₹"+l(n.unitPrice.toFixed(2)),1),e("td",Ft,"₹"+l(n.lineTotal.toFixed(2)),1)]))),128))])]),e("div",qt,[e("span",Vt," Subtotal: ₹"+l(S.value.reduce((n,E)=>n+E.lineTotal,0).toFixed(2)),1)])]),e("div",Ut,[t[20]||(t[20]=e("div",{class:"text-sm font-semibold text-slate-200 mb-2"},"New Items Value (after discounts)",-1)),e("table",At,[t[19]||(t[19]=e("thead",{class:"dark-panel"},[e("tr",null,[e("th",{class:"px-2 py-1 text-left"},"Item"),e("th",{class:"px-2 py-1 text-right"},"Qty"),e("th",{class:"px-2 py-1 text-right"},"Unit Price"),e("th",{class:"px-2 py-1 text-right"},"Net Rate"),e("th",{class:"px-2 py-1 text-right"},"Total")])],-1)),e("tbody",Lt,[(i(!0),u(W,null,ee(P.value,n=>{var E;return i(),u("tr",{key:n.id},[e("td",jt,l(n.name),1),e("td",zt,l(n.quantity),1),e("td",Ot," ₹"+l((((E=$(p).products.find(o=>o.id===n.id))==null?void 0:E.price)??0).toFixed(2)),1),e("td",Bt,"₹"+l((n.lineTotal/n.quantity).toFixed(2)),1),e("td",Wt,"₹"+l(n.lineTotal.toFixed(2)),1)])}),128))])]),e("div",Gt,[e("span",Ht," Subtotal: ₹"+l(P.value.reduce((n,E)=>n+E.lineTotal,0).toFixed(2)),1)])]),e("div",Kt,[e("div",Jt,[t[21]||(t[21]=e("div",{class:"text-xs text-slate-300"},"Returned Value",-1)),e("div",Xt,"₹"+l(w.value.returnValue.toFixed(2)),1)]),e("div",Yt,[t[22]||(t[22]=e("div",{class:"text-xs text-slate-300"},"New Items Value",-1)),e("div",Zt,"₹"+l(w.value.exchangeValue.toFixed(2)),1)])]),w.value.difference<0?(i(),u("div",es,[t[23]||(t[23]=e("div",{class:"text-sm font-semibold text-orange-800"},"Customer Pays (Difference)",-1)),e("div",ts,"₹"+l(w.value.customerPays.toFixed(2)),1),t[24]||(t[24]=e("div",{class:"mt-2 text-xs text-orange-700"},"New items cost more. Customer must pay the difference.",-1))])):w.value.difference>0?(i(),u("div",ss,[t[25]||(t[25]=e("div",{class:"text-sm font-semibold text-green-800"},"Customer Receives (Refund)",-1)),e("div",ns,"₹"+l(w.value.customerReceives.toFixed(2)),1),t[26]||(t[26]=e("div",{class:"mt-2 text-xs text-green-700"},"Returned items worth more. Customer will receive a refund.",-1))])):(i(),u("div",as,[...t[27]||(t[27]=[e("div",{class:"text-sm font-semibold text-blue-800"},"Even Exchange",-1),e("div",{class:"mt-1 text-2xl font-bold text-blue-900"},"₹0.00",-1),e("div",{class:"mt-2 text-xs text-blue-700"},"No balance due. Exchange is even.",-1)])])),F.value&&F.value.warnings.length>0?(i(),u("div",ls,[t[28]||(t[28]=e("div",{class:"text-sm font-semibold text-yellow-800"},"Warnings",-1)),e("ul",rs,[(i(!0),u(W,null,ee(F.value.warnings,n=>(i(),u("li",{key:n},l(n),1))),128))])])):I("",!0),F.value&&!F.value.valid?(i(),u("div",os,[t[29]||(t[29]=e("div",{class:"text-sm font-semibold text-red-800"},"Validation Errors",-1)),e("ul",is,[(i(!0),u(W,null,ee(F.value.errors,n=>(i(),u("li",{key:n},l(n),1))),128))])])):I("",!0)])):I("",!0)])):I("",!0),d.value===4?(i(),u("div",ds,[t[36]||(t[36]=e("h3",{class:"text-lg font-semibold text-slate-100"},"Step 4: Payment & Refund Details",-1)),e("div",us,[e("div",null,[t[31]||(t[31]=e("label",{class:"block text-sm font-medium text-slate-200"},"Refund Reason",-1)),de(e("input",{"onUpdate:modelValue":t[2]||(t[2]=n=>G.value=n),type:"text",placeholder:"e.g., Damaged item, wrong size, etc.",class:"mt-1 w-full rounded-md border border-[rgba(255,255,255,0.06)] px-3 py-2 text-sm bg-white dark:bg-slate-800 dark:text-slate-100"},null,512),[[ve,G.value]])]),w.value&&w.value.difference<0?(i(),u("div",cs,[t[33]||(t[33]=e("label",{class:"block text-sm font-medium text-slate-200"},"Payment Method",-1)),de(e("select",{"onUpdate:modelValue":t[3]||(t[3]=n=>H.value=n),class:"mt-1 w-full rounded-md border border-[rgba(255,255,255,0.06)] px-3 py-2 text-sm bg-white dark:bg-slate-800 dark:text-slate-100"},[...t[32]||(t[32]=[e("option",{value:"cash"},"Cash",-1),e("option",{value:"card"},"Card",-1),e("option",{value:"mobile"},"Mobile Payment",-1)])],512),[[me,H.value]]),e("p",xs,"Customer will pay ₹"+l(w.value.customerPays.toFixed(2))+" via this method.",1)])):I("",!0),w.value&&w.value.difference>0?(i(),u("div",fs,[t[35]||(t[35]=e("label",{class:"block text-sm font-medium text-slate-200"},"Refund Method",-1)),de(e("select",{"onUpdate:modelValue":t[4]||(t[4]=n=>j.value=n),class:"mt-1 w-full rounded-md border border-[rgba(255,255,255,0.06)] px-3 py-2 text-sm bg-white dark:bg-slate-800 dark:text-slate-100"},[...t[34]||(t[34]=[e("option",{value:"cash"},"Cash Refund",-1),e("option",{value:"store_credit"},"Store Credit",-1),e("option",{value:"wallet"},"Credit to Wallet",-1)])],512),[[me,j.value]]),e("p",vs,"Customer will receive ₹"+l(w.value.customerReceives.toFixed(2))+" via this method.",1)])):I("",!0)])])):I("",!0),d.value===5?(i(),u("div",ms,[t[41]||(t[41]=e("h3",{class:"text-lg font-semibold text-slate-100"},"Step 5: Confirm Exchange",-1)),e("div",ps,[e("div",gs,[e("div",null,[t[37]||(t[37]=e("span",{class:"font-semibold"},"Original Invoice:",-1)),ae(" #"+l((m=R.originalSale)==null?void 0:m.invoiceNumber),1)]),e("div",null,[t[38]||(t[38]=e("span",{class:"font-semibold"},"Items Returning:",-1)),ae(" "+l(S.value.length)+" item(s)",1)]),e("div",null,[t[39]||(t[39]=e("span",{class:"font-semibold"},"Items Exchanging:",-1)),ae(" "+l(P.value.length)+" item(s)",1)]),w.value?(i(),u("div",hs,[t[40]||(t[40]=e("span",{class:"font-semibold"},"Difference:",-1)),e("span",{class:ce(w.value.difference<0?"text-orange-600":w.value.difference>0?"text-green-600":"text-blue-600")},l(w.value.difference<0?`Customer pays ₹${w.value.customerPays.toFixed(2)}`:w.value.difference>0?`Customer receives ₹${w.value.customerReceives.toFixed(2)}`:"Even exchange - No balance"),3)])):I("",!0)])]),t[42]||(t[42]=e("div",{class:"rounded-lg border border-yellow-200 bg-yellow-50 p-3"},[e("p",{class:"text-sm text-yellow-800"},[e("strong",null,"Please confirm:"),ae(" This action will update inventory, create new invoices, and process payments/refunds. ")])],-1))])):I("",!0)]),e("div",bs,[d.value>1?(i(),u("button",{key:0,type:"button",class:"rounded-md border border-[rgba(255,255,255,0.06)] px-4 py-2 text-sm font-medium text-slate-200 hover:dark-panel",onClick:X}," Previous ")):(i(),u("div",ys)),e("div",ks,[e("button",{type:"button",class:"rounded-md border border-[rgba(255,255,255,0.06)] px-4 py-2 text-sm font-medium text-slate-200 hover:dark-panel",onClick:le}," Cancel "),d.value<ue?(i(),u("button",{key:0,type:"button",class:"rounded-md bg-orange-600 px-4 py-2 text-sm font-medium text-white hover:bg-orange-700",onClick:U}," Next ")):(i(),u("button",{key:1,type:"button",disabled:V.value||!((T=F.value)!=null&&T.valid),class:"rounded-md bg-green-600 px-4 py-2 text-sm font-medium text-white hover:bg-green-700 disabled:cursor-not-allowed disabled:bg-gray-400",onClick:re},l(V.value?"Processing...":"Confirm Exchange"),9,_s))])])])])):I("",!0)}}});function Rs(){const R=he(),N=ye(),b=be(),C=Ce(),p=$e(),s=Ie({saleId:null,refundType:"full_return",reason:"",returnQuantities:new Map,exchangeReturnQuantities:new Map,exchangeNewQuantities:new Map,isProcessing:!1}),d=A(null),y=A(null),c=q(()=>s.saleId?R.sales.find(o=>o.id===s.saleId)??null:null),x=q(()=>c.value?N.refundsForSale(c.value.id):[]),M=q(()=>{const o=new Map;return x.value.forEach(v=>{v.refundedItems.forEach(f=>{o.set(f.id,(o.get(f.id)||0)+f.quantity)})}),o}),w=q(()=>{if(!c.value)return[];const o=c.value.subtotal||0,v=c.value.invoiceDiscountAmount||0;return c.value.items.map(f=>{const h=M.value.get(f.id)||0,k=Math.max(0,f.quantity-h),Q=f.lineTotal??f.unitPrice*f.quantity,L=o>0?Q/o*v:0,Y=f.quantity>0?L/f.quantity:0,se=f.quantity>0?Q/f.quantity-Y:0;return{productId:f.id,name:f.name,purchasedQty:f.quantity,refundedQty:h,remainingQty:k,originalUnitPrice:f.unitPrice,unitPrice:se,lineTotal:Q-L}})}),F=q(()=>{const o=s.refundType==="exchange"?s.exchangeReturnQuantities:s.returnQuantities;let v=0;return o.forEach(f=>{v+=f}),v}),G=q(()=>{let o=0;return(s.refundType==="exchange"?s.exchangeReturnQuantities:s.returnQuantities).forEach((f,h)=>{const k=w.value.find(Q=>Q.productId===h);k&&(o+=k.unitPrice*f)}),o}),j=q(()=>{let o=0;return s.exchangeNewQuantities.forEach((v,f)=>{const h=b.products.find(k=>k.id===f);h&&(o+=h.price*v)}),o}),H=q(()=>s.refundType!=="exchange"?0:G.value-j.value),V=q(()=>Math.max(0,H.value)),ne=q(()=>Math.max(0,-H.value)),K=q(()=>c.value?s.refundType==="cash_refund"?"Cash Refund":`Original - ${c.value.paymentType.toUpperCase()}`:"Original Payment"),S=q(()=>({refundType:s.refundType,reason:s.reason.trim(),totalReturnQuantity:F.value,totalReturnValue:G.value,totalExchangeValue:j.value,balanceToCustomer:V.value,balanceFromCustomer:ne.value,refundMethod:K.value}));function P(){s.returnQuantities.clear(),s.exchangeReturnQuantities.clear(),s.exchangeNewQuantities.clear()}function J(){s.saleId=null,s.refundType="full_return",s.reason="",P(),s.isProcessing=!1,d.value=null,y.value=null}function te(o){s.saleId=o,P(),d.value=null,y.value=null,o&&(s.refundType==="full_return"?D():(s.refundType==="partial_return"||s.refundType==="cash_refund")&&_e(()=>{for(const v of w.value)v.remainingQty>0&&s.returnQuantities.set(v.productId,v.remainingQty)}))}function z(o){s.refundType=o,P(),o==="full_return"?D():(o==="partial_return"||o==="cash_refund")&&c.value&&_e(()=>{for(const v of w.value)v.remainingQty>0&&s.returnQuantities.set(v.productId,v.remainingQty)})}function D(){if(c.value){P();for(const o of w.value){if(o.remainingQty<=0){d.value="This invoice has already been refunded fully.",s.refundType="partial_return";return}s.returnQuantities.set(o.productId,o.remainingQty)}}}function U(o,v){if(!c.value)return;const f=s.refundType==="exchange"?s.exchangeReturnQuantities:s.returnQuantities,h=w.value.find(Q=>Q.productId===o);if(!h)return;const k=Math.min(Math.max(v,0),h.remainingQty);k<=0?f.delete(o):f.set(o,k)}function X(o,v){const f=b.products.find(k=>k.id===o);if(!f)return;const h=Math.min(Math.max(v,0),f.stock);h<=0?s.exchangeNewQuantities.delete(o):s.exchangeNewQuantities.set(o,h)}function re(){if(d.value=null,!c.value)return d.value="Select an invoice before processing a refund.",!1;if(s.refundType==="full_return"&&s.returnQuantities.size===0)return d.value="All items in the invoice have already been refunded.",!1;if((s.refundType==="partial_return"||s.refundType==="cash_refund")&&s.returnQuantities.size===0)return d.value="Select at least one item to refund.",!1;if(s.refundType==="exchange"){if(s.exchangeReturnQuantities.size===0)return d.value="Select the items being returned.",!1;if(s.exchangeNewQuantities.size===0)return d.value="Select the replacement items for the exchange.",!1}return!0}function le(o){const v=[];return o.forEach((f,h)=>{if(!c.value)return;const k=c.value.items.find(g=>g.id===h);if(!k)return;const Q=c.value.subtotal||0,L=c.value.invoiceDiscountAmount||0,Y=k.lineTotal??k.unitPrice*k.quantity,se=Q>0?Y/Q*L:0,O=k.quantity>0?se/k.quantity:0,oe=k.quantity>0?Y/k.quantity-O:0,Z=oe*f;v.push({id:h,name:k.name,quantity:f,unitPrice:oe,lineTotal:Z})}),v}function _(){const o=[];return s.exchangeNewQuantities.forEach((v,f)=>{const h=b.products.find(k=>k.id===f);h&&o.push({id:h.id,name:h.name,quantity:v,unitPrice:h.price,lineTotal:h.price*v})}),o}function t(o){o.forEach(v=>{const f=b.products.find(h=>h.id===v.id);f&&b.update(f.id,{stock:(f.stock??0)+v.quantity})})}function m(o){o.length&&b.decrementStock(o.map(v=>({id:v.id,quantity:v.quantity})))}function T(){p.currentRoute.value.path!=="/pos"&&p.push("/pos")}async function n(o,v,f,h,k){if(!c.value)return d.value="No sale selected for exchange.",null;s.isProcessing=!0;try{const Q=await Fe(c.value,o,v,f,h,k,R,b,N,C);return Q.success?(y.value=Q.message,P(),s.reason=""):d.value=Q.message,Q}catch(Q){return d.value=Q instanceof Error?Q.message:"Unexpected error during exchange processing.",null}finally{s.isProcessing=!1}}async function E(){var v,f,h,k;if(s.isProcessing||!re()||!c.value)return null;s.isProcessing=!0;try{let Q=[],L,Y=0,se,O=0;s.refundType==="exchange"?(Q=le(s.exchangeReturnQuantities),L=_(),O=H.value,Y=O>0?O:0):(Q=le(s.returnQuantities),Y=G.value),t(Q),s.refundType==="exchange"&&(L!=null&&L.length)&&(m(L),se=R.recordSale({datetime:new Date().toISOString(),items:L.map(g=>({id:g.id,name:g.name,quantity:g.quantity,unitPrice:g.unitPrice,discountMode:"flat",discountValue:0,lineDiscount:0,lineTotal:g.lineTotal})),subtotal:j.value,productDiscountTotal:0,invoiceDiscountMode:"flat",invoiceDiscountValue:0,invoiceDiscountAmount:0,totalDiscount:0,total:j.value,paymentType:O<0?"cash":c.value.paymentType,cashier:((v=C.user)==null?void 0:v.displayName)||((f=C.user)==null?void 0:f.username)||"Cashier",customerId:c.value.customerId,customerName:c.value.customerName}));const oe=N.recordRefund({saleId:c.value.id,invoiceNumber:c.value.invoiceNumber,refundType:s.refundType,refundReason:s.reason.trim()||void 0,refundedItems:Q,exchangedItems:L,totalRefund:Y,refundMethod:K.value,paymentMethod:c.value.paymentType,exchangeDifference:O!==0?O:void 0,exchangeSaleId:se==null?void 0:se.id,cashier:((h=C.user)==null?void 0:h.displayName)||((k=C.user)==null?void 0:k.username)||"Cashier"});if(!oe)throw new Error("Unable to record refund. Please ensure a store is selected.");let Z="Refund processed successfully.";return s.refundType==="exchange"?O>0?Z=`Exchange complete. Refund ₹${O.toFixed(2)} to customer.`:O<0?(Z=`Exchange complete. Customer pays ₹${Math.abs(O).toFixed(2)}.`,T()):Z="Exchange complete. No balance due.":s.refundType==="cash_refund"?Z=`Cash refund of ₹${Y.toFixed(2)} recorded.`:s.refundType==="full_return"?Z=`Full refund of ₹${Y.toFixed(2)} recorded.`:s.refundType==="partial_return"&&(Z=`Partial refund of ₹${Y.toFixed(2)} recorded.`),y.value=Z,P(),s.reason="",{refundRecord:oe,exchangeSale:se,message:Z}}catch(Q){return d.value=Q instanceof Error?Q.message:"Unexpected error while processing the refund.",null}finally{s.isProcessing=!1}}return{state:s,sale:c,existingRefunds:x,refundableItems:w,summary:S,error:d,success:y,selectSale:te,setRefundType:z,setReturnQuantity:U,setExchangeNewQuantity:X,processRefund:E,processExchangeRefund:n,resetState:J,autoSelectFullReturn:D}}const $s={class:"space-y-6"},Ts={class:"glass-panel space-y-4"},Cs={key:0,class:"rounded-2xl border border-red-100 bg-red-50/80 dark:bg-red-900/40 dark:border-red-700 px-4 py-2 text-sm text-red-700 dark:text-red-300"},Is={key:1,class:"rounded-2xl border border-emerald-100 bg-emerald-50/80 dark:bg-emerald-900/30 dark:border-emerald-700 px-4 py-2 text-sm text-emerald-700 dark:text-emerald-200"},Ns={class:"grid grid-cols-1 gap-4 lg:grid-cols-4"},Qs={key:0,class:"absolute z-50 mt-2 max-h-60 w-full overflow-auto rounded-2xl border border-slate-100 bg-white dark:bg-slate-800 dark:border-slate-700 invoice-dropdown"},Ps=["onClick"],Ms={class:"inv-number font-semibold"},Es={class:"ml-2 text-slate-500 dark:text-slate-300"},Ss={class:"block inv-date"},Ds={class:"ml-2 text-slate-400 dark:text-slate-300 payment-type"},Fs=["value"],qs={class:"mt-1 rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm text-slate-700 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-200"},Vs={key:2,class:"rounded-2xl border border-slate-100 bg-slate-50 p-4 dark:bg-slate-800 dark:border-slate-700"},Us={class:"flex flex-wrap gap-4 text-sm text-slate-700 dark:text-slate-300"},As={key:0},Ls={key:3,class:"mt-6 space-y-6"},js={key:0,class:"overflow-hidden rounded-2xl border border-slate-100 dark:border-slate-700"},zs={class:"table-modern w-full"},Os={class:"font-medium text-slate-900 dark:text-slate-100"},Bs={class:"text-right text-slate-400 dark:text-slate-300"},Ws={class:"text-right text-slate-500 dark:text-slate-400"},Gs={class:"text-right text-slate-400 dark:text-slate-300"},Hs={class:"text-right text-slate-400 dark:text-slate-300"},Ks={class:"text-right"},Js=["disabled","value","max","onInput"],Xs={class:"text-right font-semibold text-slate-900 dark:text-slate-100"},Ys={key:1,class:"grid gap-4 lg:grid-cols-2"},Zs={class:"overflow-hidden rounded-lg border border-transparent"},en={class:"max-h-72 overflow-auto"},tn={class:"min-w-full text-xs"},sn={class:"divide-y divide-gray-100 dark:divide-gray-700"},nn={class:"px-3 py-2 font-medium text-slate-100 dark:text-slate-100"},an={class:"px-3 py-2 text-right text-slate-300 dark:text-slate-300"},ln={class:"px-3 py-2 text-right"},rn=["value","max","onInput"],on={class:"overflow-hidden rounded-lg border border-transparent"},dn={class:"max-h-72 overflow-auto"},un={class:"min-w-full text-xs"},cn={class:"divide-y divide-gray-100 dark:divide-gray-700"},xn={class:"px-3 py-2 font-medium text-slate-100 dark:text-slate-100"},fn={class:"px-3 py-2 text-right text-slate-300 dark:text-slate-300"},vn={class:"px-3 py-2 text-right"},mn=["value","max","onInput"],pn={class:"rounded-lg border border-transparent p-4 dark:bg-slate-800 dark:border-slate-700"},gn={class:"mt-3 grid grid-cols-1 gap-3 sm:grid-cols-2"},hn={class:"rounded-md bg-orange-50 px-3 py-2 text-sm text-orange-800 dark:bg-orange-900/30 dark:text-orange-200"},bn={class:"text-lg font-semibold"},yn={class:"rounded-md bg-orange-50 px-3 py-2 text-sm text-orange-800 dark:bg-orange-900/30 dark:text-orange-200"},kn={class:"text-lg font-semibold"},_n={key:0,class:"rounded-md bg-blue-50 px-3 py-2 text-sm text-blue-800 dark:bg-blue-900/30 dark:text-blue-200"},wn={class:"text-lg font-semibold"},Rn={key:1,class:"rounded-md bg-green-50 px-3 py-2 text-sm text-green-800 dark:bg-green-900/30 dark:text-green-200"},$n={class:"text-lg font-semibold"},Tn={key:2,class:"rounded-md bg-red-50 px-3 py-2 text-sm text-red-700 dark:bg-red-900/30 dark:text-red-200"},Cn={class:"text-lg font-semibold"},In={key:0,class:"mt-3 text-sm text-slate-300 dark:text-slate-300"},Nn={class:"flex justify-end gap-3"},Qn=["disabled"],Pn=["disabled"],Mn={class:"glass-panel p-4 refund-history"},En={key:0,class:"mt-4 text-sm text-slate-600 dark:text-slate-400"},Sn={key:1,class:"mt-4 max-h-[400px] overflow-y-auto divide-y divide-gray-100 dark:divide-gray-700 text-sm"},Dn={class:"flex flex-wrap justify-between gap-2"},Fn={class:"pr-4"},qn={class:"font-semibold text-slate-900 dark:text-slate-100 title"},Vn={class:"text-xs text-slate-400 dark:text-slate-300 meta"},Un={class:"mt-1 text-xs text-slate-400 dark:text-slate-300 meta"},An={key:0,class:"mt-1 text-xs text-slate-400 dark:text-slate-300 meta"},Ln={class:"text-right"},jn={class:"text-sm font-semibold text-slate-900 dark:text-slate-100 amount"},zn={key:0,class:"text-xs text-slate-400 dark:text-slate-300"},On={class:"text-xs text-slate-400 dark:text-slate-300"},Hn=Re({__name:"RefundManager",setup(R){const N=Ne();$e();const b=he(),C=ye(),p=be(),{state:s,sale:d,existingRefunds:y,refundableItems:c,summary:x,error:M,success:w,selectSale:F,setRefundType:G,setReturnQuantity:j,setExchangeNewQuantity:H,processRefund:V,processExchangeRefund:ne,resetState:K,autoSelectFullReturn:S}=Rs(),P=A(""),J=A(!1),te=A(null),z=A(!1),D=A(!1),U=A(null),X=A(!1),re=q(()=>[...b.sales].sort((g,a)=>new Date(a.datetime).getTime()-new Date(g.datetime).getTime())),le=q(()=>{const g=P.value.trim().toLowerCase();return g?re.value.filter(a=>{var ke;const r=a.invoiceNumber.toLowerCase().includes(g),B=(ke=a.customerName)==null?void 0:ke.toLowerCase().includes(g),ie=a.items.some(Te=>Te.name.toLowerCase().includes(g));return r||B||ie}):re.value}),_=[{label:"Full Return",value:"full_return"},{label:"Partial Return",value:"partial_return"},{label:"Exchange",value:"exchange"},{label:"Cash Refund",value:"cash_refund"}],t=q({get:()=>s.refundType,set:g=>G(g)}),m=q({get:()=>s.reason,set:g=>{s.reason=g}}),T=q(()=>{if(!d.value||s.isProcessing)return!1;switch(s.refundType){case"full_return":return s.returnQuantities.size>0;case"partial_return":case"cash_refund":return s.returnQuantities.size>0;case"exchange":return s.exchangeReturnQuantities.size>0&&s.exchangeNewQuantities.size>0;default:return!1}}),n=q(()=>C.refundsForCurrentStore.slice().reverse());function E(g){te.value&&(g&&te.value.contains(g.target)||(J.value=!1))}function o(g){F(g);const a=re.value.find(r=>r.id===g);P.value=(a==null?void 0:a.invoiceNumber)??"",J.value=!1}function v(g,a){const r=Number(a);Number.isNaN(r)||j(g,r)}function f(g,a){const r=Number(a);Number.isNaN(r)||j(g,r)}function h(g,a){const r=Number(a);Number.isNaN(r)||H(g,r)}function k(){P.value="",U.value=null,z.value=!1,K()}function Q(){if(!d.value)return"Confirm refund?";const g=d.value.invoiceNumber;return s.refundType==="exchange"?x.value.balanceToCustomer>0?`Confirm exchange for invoice #${g}? Refund ₹${x.value.balanceToCustomer.toFixed(2)} to customer.`:x.value.balanceFromCustomer>0?`Confirm exchange for invoice #${g}? Customer must pay ₹${x.value.balanceFromCustomer.toFixed(2)}.`:`Confirm exchange for invoice #${g}?`:`Are you sure you want to refund ${x.value.totalReturnQuantity} item(s) from invoice #${g}?`}async function L(){if(!T.value||X.value||!window.confirm(Q()))return;X.value=!0;const a=await V();a!=null&&a.refundRecord&&(U.value=a.refundRecord,z.value=!0,F(a.refundRecord.saleId),w.value=a.message),X.value=!1}function Y(){z.value=!1,U.value=null}function se(){if(!d.value){M.value="Please select an invoice first.";return}D.value=!0}function O(g){X.value=!0,ne(g.returnedItems,g.exchangedItems,g.refundReason||void 0,g.refundMethod,g.paymentType).then(a=>{if(a!=null&&a.success){C.load();const r=C.refundsForCurrentStore.filter(B=>{var ie;return B.saleId===((ie=d.value)==null?void 0:ie.id)}).sort((B,ie)=>new Date(ie.createdAt).getTime()-new Date(B.createdAt).getTime())[0];r&&(U.value=r,z.value=!0),D.value=!1}X.value=!1})}function oe(){D.value=!1}function Z(){const g=N.query.invoice;if(!g)return;const a=b.sales.find(r=>r.invoiceNumber===g||r.id===g);a&&(o(a.id),S())}return Qe(()=>{b.load(),p.load(),C.load(),document.addEventListener("click",E),P.value="",Z()}),Pe(()=>{document.removeEventListener("click",E)}),fe(()=>N.query.invoice,()=>Z()),(g,a)=>(i(),u(W,null,[e("div",$s,[a[29]||(a[29]=Me('<section class="grid gap-4 lg:grid-cols-3"><div class="glass-panel space-y-2 border border-blue-100 bg-blue-50/60 dark:bg-[rgba(14,23,32,0.6)] dark:border-blue-900"><div class="subtle-label dark:text-slate-400 text-slate-600">Step 1</div><h2 class="section-heading dark:text-slate-100">Select invoice</h2><p class="text-sm text-slate-600 dark:text-slate-400">Search invoices, customers, or items to start a refund workflow.</p></div><div class="glass-panel space-y-2 border border-emerald-100 bg-emerald-50/70 dark:bg-[rgba(14,23,32,0.6)] dark:border-emerald-900"><div class="subtle-label dark:text-slate-400 text-slate-600">Step 2</div><h2 class="section-heading dark:text-slate-100">Choose refund type</h2><p class="text-sm text-slate-600 dark:text-slate-400">Switch between full, partial, exchange, or cash refunds anytime.</p></div><div class="glass-panel space-y-2 border border-amber-100 bg-amber-50/70 dark:bg-[rgba(14,23,32,0.6)] dark:border-amber-900"><div class="subtle-label dark:text-slate-400 text-slate-600">Step 3</div><h2 class="section-heading dark:text-slate-100">Review &amp; confirm</h2><p class="text-sm text-slate-600 dark:text-slate-400">Totals, balances, and inventory updates stay in sync automatically.</p></div></section>',1)),e("section",Ts,[e("div",{class:"flex items-center justify-between"},[a[5]||(a[5]=e("h3",{class:"section-heading dark:text-slate-100"},"Refund Details",-1)),e("button",{class:"quick-filter text-xs",type:"button",onClick:k},"Reset")]),$(M)?(i(),u("div",Cs,l($(M)),1)):I("",!0),$(w)?(i(),u("div",Is,l($(w)),1)):I("",!0),e("div",Ns,[e("div",{class:"relative lg:col-span-2",ref_key:"dropdownRef",ref:te},[a[6]||(a[6]=e("label",{class:"subtle-label dark:text-slate-400"},"Invoice",-1)),de(e("input",{"onUpdate:modelValue":a[0]||(a[0]=r=>P.value=r),type:"search",placeholder:"Search invoice, customer, or product",class:"input-field dark:bg-slate-800 dark:text-slate-100",onFocus:a[1]||(a[1]=r=>J.value=!0),onInput:a[2]||(a[2]=r=>J.value=!0)},null,544),[[ve,P.value]]),J.value&&le.value.length?(i(),u("div",Qs,[(i(!0),u(W,null,ee(le.value,r=>(i(),u("button",{key:r.id,type:"button",class:"flex w-full items-start justify-between px-4 py-2 text-left text-xs hover:bg-blue-50 dark:hover:bg-blue-900/40",onClick:B=>o(r.id)},[e("span",null,[e("span",Ms,"#"+l(r.invoiceNumber),1),e("span",Es,"₹"+l(r.total.toFixed(2)),1),e("span",Ss,l(new Date(r.datetime).toLocaleString()),1)]),e("span",Ds,l(r.paymentType),1)],8,Ps))),128))])):I("",!0)],512),e("div",null,[a[7]||(a[7]=e("label",{class:"subtle-label dark:text-slate-400"},"Refund Type",-1)),de(e("select",{"onUpdate:modelValue":a[3]||(a[3]=r=>t.value=r),class:"input-field dark:bg-slate-800 dark:text-slate-100"},[(i(),u(W,null,ee(_,r=>e("option",{key:r.value,value:r.value},l(r.label),9,Fs)),64))],512),[[me,t.value]])]),e("div",null,[a[8]||(a[8]=e("label",{class:"subtle-label dark:text-slate-400"},"Refund Method",-1)),e("div",qs,l($(x).refundMethod),1)]),e("div",null,[a[9]||(a[9]=e("label",{class:"subtle-label dark:text-slate-400"},"Refund Reason",-1)),de(e("input",{"onUpdate:modelValue":a[4]||(a[4]=r=>m.value=r),type:"text",placeholder:"Damaged item, wrong size, etc.",class:"input-field dark:bg-slate-800 dark:text-slate-100"},null,512),[[ve,m.value]])])]),$(d)?(i(),u("div",Vs,[e("div",Us,[e("div",null,[a[10]||(a[10]=e("span",{class:"font-semibold text-slate-900 dark:text-slate-100"},"Invoice:",-1)),ae(" #"+l($(d).invoiceNumber),1)]),e("div",null,[a[11]||(a[11]=e("span",{class:"font-semibold text-slate-900 dark:text-slate-100"},"Date:",-1)),ae(" "+l(new Date($(d).datetime).toLocaleString()),1)]),e("div",null,[a[12]||(a[12]=e("span",{class:"font-semibold text-slate-900 dark:text-slate-100"},"Payment:",-1)),ae(" "+l($(d).paymentType),1)]),$(d).customerName?(i(),u("div",As,[a[13]||(a[13]=e("span",{class:"font-semibold text-slate-900 dark:text-slate-100"},"Customer:",-1)),ae(" "+l($(d).customerName),1)])):I("",!0),e("div",null,[a[14]||(a[14]=e("span",{class:"font-semibold text-slate-900 dark:text-slate-100"},"Total:",-1)),ae(" ₹"+l($(d).total.toFixed(2)),1)])])])):I("",!0),$(d)?(i(),u("div",Ls,[t.value!=="exchange"?(i(),u("div",js,[e("table",zs,[a[15]||(a[15]=e("thead",{class:"bg-white dark:bg-slate-800"},[e("tr",null,[e("th",{class:"text-left"},"Item"),e("th",{class:"text-right"},"Purchased"),e("th",{class:"text-right"},"Refunded"),e("th",{class:"text-right"},"Available"),e("th",{class:"text-right"},"Unit Price"),e("th",{class:"text-right"},"Return Qty"),e("th",{class:"text-right"},"Line Total")])],-1)),e("tbody",null,[(i(!0),u(W,null,ee($(c),r=>(i(),u("tr",{key:r.productId},[e("td",Os,l(r.name),1),e("td",Bs,l(r.purchasedQty),1),e("td",Ws,l(r.refundedQty),1),e("td",Gs,l(r.remainingQty),1),e("td",Hs,"₹"+l(r.unitPrice.toFixed(2)),1),e("td",Ks,[e("input",{disabled:t.value==="full_return",value:$(s).returnQuantities.get(r.productId)??r.remainingQty,max:r.remainingQty,min:"0",type:"number",class:"input-field w-24 rounded-full text-right disabled:bg-slate-100 dark:disabled:bg-slate-700",onInput:B=>v(r.productId,B.target.value)},null,40,Js)]),e("td",Xs," ₹"+l((($(s).returnQuantities.get(r.productId)??r.remainingQty)*r.unitPrice).toFixed(2)),1)]))),128))])])])):(i(),u("div",Ys,[e("div",Zs,[a[17]||(a[17]=e("div",{class:"dark-panel px-4 py-2 text-sm font-semibold text-slate-200"},"Items Being Returned",-1)),e("div",en,[e("table",tn,[a[16]||(a[16]=e("thead",{class:"sticky top-0 bg-white dark:bg-slate-800 text-slate-400 dark:text-slate-300"},[e("tr",null,[e("th",{class:"px-3 py-2 text-left font-medium"},"Item"),e("th",{class:"px-3 py-2 text-right font-medium"},"Available"),e("th",{class:"px-3 py-2 text-right font-medium"},"Return Qty")])],-1)),e("tbody",sn,[(i(!0),u(W,null,ee($(c),r=>(i(),u("tr",{key:r.productId},[e("td",nn,l(r.name),1),e("td",an,l(r.remainingQty),1),e("td",ln,[e("input",{value:$(s).exchangeReturnQuantities.get(r.productId)??0,max:r.remainingQty,min:"0",type:"number",class:"w-20 rounded-md border border-[rgba(255,255,255,0.06)] px-2 py-1 text-right text-xs outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500 dark:bg-slate-800 dark:text-slate-100",onInput:B=>f(r.productId,B.target.value)},null,40,rn)])]))),128))])])])]),e("div",on,[a[19]||(a[19]=e("div",{class:"dark-panel px-4 py-2 text-sm font-semibold text-slate-200"},"Replacement Items",-1)),e("div",dn,[e("table",un,[a[18]||(a[18]=e("thead",{class:"sticky top-0 bg-white dark:bg-slate-800 text-slate-400 dark:text-slate-300"},[e("tr",null,[e("th",{class:"px-3 py-2 text-left font-medium"},"Product"),e("th",{class:"px-3 py-2 text-right font-medium"},"Stock"),e("th",{class:"px-3 py-2 text-right font-medium"},"Exchange Qty")])],-1)),e("tbody",cn,[(i(!0),u(W,null,ee($(p).products,r=>(i(),u("tr",{key:r.id},[e("td",xn,l(r.name),1),e("td",fn,l(r.stock),1),e("td",vn,[e("input",{value:$(s).exchangeNewQuantities.get(r.id)??0,max:r.stock,min:"0",type:"number",class:"w-20 rounded-md border border-[rgba(255,255,255,0.06)] px-2 py-1 text-right text-xs outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500 dark:bg-slate-800 dark:text-slate-100",onInput:B=>h(r.id,B.target.value)},null,40,mn)])]))),128))])])])])])),e("div",pn,[a[26]||(a[26]=e("h4",{class:"text-base font-semibold text-slate-100"},"Refund Summary",-1)),e("div",gn,[e("div",hn,[a[20]||(a[20]=e("div",{class:"font-medium uppercase tracking-wide text-xs text-orange-600 dark:text-orange-300"},"Items Refunded",-1)),e("div",bn,l($(x).totalReturnQuantity),1)]),e("div",yn,[a[21]||(a[21]=e("div",{class:"font-medium uppercase tracking-wide text-xs text-orange-600 dark:text-orange-300"},"Refund Amount",-1)),e("div",kn,"₹"+l($(x).totalReturnValue.toFixed(2)),1)]),t.value==="exchange"?(i(),u("div",_n,[a[22]||(a[22]=e("div",{class:"font-medium uppercase tracking-wide text-xs text-blue-600 dark:text-blue-300"},"Replacement Value",-1)),e("div",wn,"₹"+l($(x).totalExchangeValue.toFixed(2)),1)])):I("",!0),t.value==="exchange"&&$(x).balanceToCustomer>0?(i(),u("div",Rn,[a[23]||(a[23]=e("div",{class:"font-medium uppercase tracking-wide text-xs text-green-600 dark:text-green-300"},"Refund To Customer",-1)),e("div",$n,"₹"+l($(x).balanceToCustomer.toFixed(2)),1)])):I("",!0),t.value==="exchange"&&$(x).balanceFromCustomer>0?(i(),u("div",Tn,[a[24]||(a[24]=e("div",{class:"font-medium uppercase tracking-wide text-xs text-red-600 dark:text-red-300"},"Customer Pays",-1)),e("div",Cn,"₹"+l($(x).balanceFromCustomer.toFixed(2)),1)])):I("",!0)]),$(x).reason?(i(),u("div",In,[a[25]||(a[25]=e("span",{class:"font-medium text-slate-200 dark:text-slate-200"},"Reason:",-1)),ae(" "+l($(x).reason),1)])):I("",!0)]),e("div",Nn,[e("button",{class:"rounded-md border border-[rgba(255,255,255,0.06)] px-4 py-2 text-sm text-slate-200 hover:dark-panel dark:border-slate-700",type:"button",onClick:k}," Cancel "),t.value==="exchange"?(i(),u("button",{key:0,disabled:!$(d),class:"rounded-md bg-blue-600 px-5 py-2 text-sm font-semibold text-white shadow hover:bg-blue-700 disabled:cursor-not-allowed disabled:bg-gray-600",type:"button",onClick:se}," Start Exchange Process ",8,Qn)):(i(),u("button",{key:1,disabled:!T.value||$(s).isProcessing,class:"rounded-md bg-orange-600 px-5 py-2 text-sm font-semibold text-white shadow disabled:cursor-not-allowed disabled:bg-gray-600",type:"button",onClick:L},l($(s).isProcessing?"Processing...":"Process Refund"),9,Pn))])])):I("",!0)]),e("section",Mn,[a[27]||(a[27]=e("h3",{class:"text-lg font-semibold text-slate-900 dark:text-slate-100 title"},"Refund History",-1)),a[28]||(a[28]=e("p",{class:"mt-1 text-xs text-slate-400 dark:text-slate-300 subtitle"},"Most recent refunds for this store.",-1)),n.value.length===0?(i(),u("div",En,"No refunds recorded yet.")):(i(),u("ul",Sn,[(i(!0),u(W,null,ee(n.value,r=>(i(),u("li",{key:r.refundId,class:"py-3"},[e("div",Dn,[e("div",Fn,[e("div",qn,l(r.refundType.replace(/_/g," ").replace(/\b\w/g,B=>B.toUpperCase()))+" • "+l(r.refundId),1),e("div",Vn,l(new Date(r.createdAt).toLocaleString())+" • Invoice #"+l(r.invoiceNumber),1),e("div",Un,"Cashier: "+l(r.cashier),1),r.refundReason?(i(),u("div",An,"Reason: "+l(r.refundReason),1)):I("",!0)]),e("div",Ln,[e("div",jn,"₹"+l(r.totalRefund.toFixed(2)),1),r.exchangeDifference?(i(),u("div",zn," Net Δ ₹"+l(r.exchangeDifference.toFixed(2)),1)):I("",!0),e("div",On,l(r.refundMethod),1)])])]))),128))]))])]),z.value&&U.value&&$(d)?(i(),we(Ee,{key:0,refund:U.value,sale:$(d),existingRefunds:$(y),onClose:Y},null,8,["refund","sale","existingRefunds"])):I("",!0),D.value?(i(),we(ws,{key:1,"original-sale":$(d),show:D.value,onClose:oe,onConfirm:O},null,8,["original-sale","show"])):I("",!0)],64))}});export{Hn as default};
